# 이미지 매칭 로직 문서

## 개요

상품명과 이미지 파일명을 자동으로 매칭하는 3단계 검증 시스템입니다.

## 매칭 컨셉

### 3단계 검증 구조

```
1차: 현재 로직으로 정확한 매칭 확인
  ↓ (정확한 매칭 실패)
2차: 라이브러리로 정확한 매칭 확인
  ↓ (정확한 매칭 실패)
3차: 가장 가까운 이미지로 매칭 (fallback)
```

### 정확한 매칭 기준

정확한 매칭은 다음 기준을 만족해야 합니다:

| 매칭 방법 | 최소 점수 | 설명 |
|---------|----------|------|
| Exact Match | 0.9 이상 | 정확히 일치하는 매칭 |
| Partial Match | 0.7 이상 | 부분적으로 일치하는 매칭 |
| Similarity Match | 0.6 이상 | 유사도 기반 매칭 |

**정확한 매칭이 아닌 경우:**
- 점수가 기준 미만이면 다음 단계로 진행
- 3차 단계에서 가장 가까운 이미지 선택 (최소 0.2 이상)

## 매칭 전략

### 1. Exact Match (정확한 매칭)

**우선순위: 최고**

- 한글/영어 정확히 일치
- 로마자 변환 후 일치
- 역방향 매칭 (영어 ↔ 한글)
- 교차 매칭

**점수 범위:** 0.85 ~ 1.0

### 2. Partial Match (부분 매칭)

**우선순위: 중간**

- 포함 관계 매칭
- 변형 매칭 (의미 사전 기반)
- 단어 순서 매칭
- 핵심 명사 매칭

**점수 범위:** 0.2 ~ 0.95

**점수 조정 규칙:**
- 핵심 명사 매칭: +0.1 ~ +0.2 보너스
- 핵심 명사 미매칭: -80% ~ -90% 페널티
- 수식어만 매칭: -70% ~ -90% 페널티
- 단어 순서 일치: +0.15 ~ +0.2 보너스

### 3. Similarity Match (유사도 매칭)

**우선순위: 낮음**

- Levenshtein 거리 기반 유사도 계산
- 단어 단위 공통 부분 확인
- 최소 50% 이상 단어가 공통 부분 필요

**점수 범위:** 0.0 ~ 0.8

**필터링 조건:**
- 길이 차이 50% 이상 제외
- 공통 단어 없으면 제외
- 최소 3글자 이상 공통 접두어 필요

## 점수 체계

### 기본 점수

| 매칭 방법 | 기본 점수 | 최대 점수 |
|---------|----------|----------|
| Exact | 0.85 ~ 1.0 | 1.0 |
| Partial | 0.2 ~ 0.95 | 0.98 |
| Similarity | 0.0 ~ 0.8 | 0.8 |

### 보너스 및 페널티

#### 보너스

- **핵심 명사 완전 매칭:** +0.2 (최대 0.98)
- **핵심 명사 절반 이상 매칭:** +0.15 (최대 0.95)
- **핵심 명사 일부 매칭:** +0.1 (최대 0.9)
- **단어 순서 일치:** +0.2 (최대 0.98)
- **모든 단어 매칭:** +0.15 (최대 0.95)
- **80% 이상 단어 매칭:** +0.1 (최대 0.9)

#### 페널티

- **핵심 명사 미매칭 (수식어만):** -90% (×0.1)
- **핵심 명사 미매칭:** -80% (×0.2)
- **명사 없음 (수식어만):** -70% (×0.3)
- **접두어만 매칭:** -40% (×0.6)

## 매칭 흐름도

```
상품명 입력
    ↓
형태소 분석 (1차: 현재 로직)
    ↓
한글 → 영어 변환
    ↓
변형 생성 (의미 사전 기반)
    ↓
[Exact Match 시도]
    ↓ (실패)
[Partial Match 시도]
    ↓ (실패)
[Similarity Match 시도]
    ↓
정확한 매칭 확인
    ├─ Exact: score >= 0.9 → 성공
    ├─ Partial: score >= 0.7 → 성공
    └─ Similarity: score >= 0.6 → 성공
    ↓ (모두 실패)
라이브러리 형태소 분석 (2차)
    ↓
[동일한 매칭 전략 재시도]
    ↓
정확한 매칭 확인
    ├─ 성공 → 반환
    └─ 실패 → 3차 진행
    ↓
3차: 모든 매칭 결과 수집
    ↓
최고 점수 선택 (최소 0.2 이상)
    ↓
결과 반환
```

## 핵심 명사 우선순위

형태소 분석에서 추출된 핵심 명사는 매칭에 높은 가중치를 가집니다:

1. **핵심 명사 매칭 확인**
   - 명사 토큰 추출
   - 이미지명과 핵심 명사 비교
   - 매칭 여부에 따라 보너스/페널티 적용

2. **핵심 명사 미매칭 시**
   - 점수 크게 감소 (80% ~ 90%)
   - 수식어만 매칭된 경우 더 큰 페널티

3. **핵심 명사 매칭 시**
   - 매칭 비율에 따라 보너스 적용
   - 모든 명사 매칭: 최대 보너스
   - 절반 이상 매칭: 중간 보너스
   - 일부 매칭: 최소 보너스

## 의미 사전 활용

### 복합어 처리

공백이 있는 상품명은 공백 제거 버전으로 의미 사전을 먼저 확인합니다:

- "전통 약과" → "전통약과" 확인
- "간편 볶음밥" → "간편볶음밥" 확인
- "명품 한우 세트" → "명품한우세트" 확인

### 변형 생성

의미 사전의 동의어와 변형을 활용하여 다양한 매칭 후보를 생성합니다:

- 공백 있는 버전 / 붙여쓰기 버전
- 단수 / 복수 형태
- 단어 분리 / 조합

## 라이브러리 기반 분석 (2차)

### Kiwi-NLP 활용

1차 매칭이 정확하지 않을 경우, Kiwi-NLP 라이브러리로 형태소 분석을 재수행합니다:

1. **라이브러리 형태소 분석**
   - Kiwi-NLP로 상품명 분석
   - 품사 정보 추출
   - 핵심 단어 식별

2. **변환 및 매칭**
   - 라이브러리 분석 결과로 변환
   - 동일한 매칭 전략 적용
   - 정확한 매칭 기준 확인

3. **결과 선택**
   - 1차보다 높은 점수면 라이브러리 결과 사용
   - 정확한 매칭이면 즉시 반환

## 3차 Fallback (가장 가까운 이미지)

1차와 2차에서 정확한 매칭이 실패한 경우:

1. **모든 매칭 결과 수집**
   - 1차 매칭 결과
   - 2차 매칭 결과

2. **최고 점수 선택**
   - 모든 결과 중 최고 점수 선택
   - 최소 임계값: 0.2 이상

3. **결과 반환**
   - 가장 가까운 이미지 반환
   - 매칭 실패 시 null 반환

## 문제 해결 가이드

### "소불고기" 매칭 문제

**의미 사전:**
- `소불고기`: "beef bulgogi", "beefbulgogi"

**예상 파일명:**
- `beefBulgogi.png`

**확인 사항:**
1. 형태소 분석: "소" + "불고기" 분리 확인
2. 의미 사전: "소불고기" 복합어 확인
3. 변형 생성: "beefbulgogi", "beef bulgogi" 생성 확인

### "간편 볶음밥" 매칭 문제

**의미 사전:**
- `간편볶음밥`: "easy fried rice", "easyfriedrice"

**예상 파일명:**
- `easyFriedRice.png`

**확인 사항:**
1. 공백 제거: "간편볶음밥" 확인
2. 접두어 처리: "간편" 접두어 인식
3. 변형 생성: "easyfriedrice", "easy fried rice" 생성

### "명품 한우 세트" 매칭 문제

**의미 사전:**
- `명품한우세트`: "luxury korean beef set", "luxurykoreanbeefset"

**예상 파일명:**
- `luxuryKoreanbeefset.png`

**확인 사항:**
1. 공백 제거: "명품한우세트" 확인
2. 복합어 처리: "명품" + "한우" + "세트" 분리
3. 변형 생성: "luxurykoreanbeefset", "luxury korean beef set" 생성

## 로깅 및 디버깅

### 개발 모드 로그

매칭 과정의 상세 정보가 개발 모드에서 출력됩니다:

```
[Image Match] "상품명" -> "이미지경로" (score: 0.95, method: exact) (custom)
[Image Match] Morphology: { tokens: [...], coreWords: [...] }
[Image Match] Product Roman: "변환결과"
[Image Match] Product Variants: ["변형1", "변형2", ...]
[Image Match] Image Normalized: "이미지명"
[Image Match] Image Roman: "이미지변환결과"
```

### 2차 검증 로그

라이브러리 기반 분석 시 추가 로그:

```
[Image Match] 2차 검증 (라이브러리): "상품명"
[Image Match] 라이브러리 형태소 분석: { tokens: [...], coreWords: [...] }
[Image Match] 라이브러리 변환 결과: ["변형1", "변형2", ...]
```

## 성능 고려사항

1. **병렬 처리**
   - 여러 상품 매칭 시 Promise.all 사용
   - 이미지 파일 목록 캐싱

2. **조기 종료**
   - Exact match 발견 시 즉시 반환
   - 정확한 매칭 발견 시 다음 단계 스킵

3. **라이브러리 초기화**
   - Kiwi-NLP는 동적 import로 선택적 로드
   - 초기화 실패 시 graceful degradation

## 향후 개선 방향

1. **학습 기반 매칭**
   - 매칭 성공/실패 데이터 수집
   - 점수 가중치 자동 조정

2. **의미 사전 확장**
   - 사용자 피드백 기반 확장
   - 동의어 자동 추출

3. **캐싱 최적화**
   - 매칭 결과 캐싱
   - 형태소 분석 결과 캐싱
